<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
<script type="text/javascript" src="../js/shapeshift.js"></script>
<script type="text/javascript" src="../js/eventLoader.js"></script>
<script type="text/javascript" src="../js/pluginLoader.js"></script>

<dom-module id="event-page">
  <template>
    <paper-toolbar id="event-header" class="tall">
      <h3>HackBoard</h3>
      <paper-input class="search-input" label="search for an event" no-label-float></paper-input>
    </paper-toolbar>

    <div id="deck">
      <ul></ul>
    </div>
  </template>
</dom-module>

<script>
  var selectedEvent;
  Polymer({
    is: "event-page",
    properties: {
      id: {
        type: String
      }
    },
    attached: function(){
      var selector = '#deck ul';
      var eb = new EventLoader;
      var query = $_GET('q');

      $(document).on('eventChanged', function(e, data, status){
        // data.events is all the events that match the search.
        selectedEvent = data.events[0];
        // change the url
        window.history.pushState('', '', location.pathname + "#/" + selectedEvent.id);
        // iterate through and load all the plugins in pluginIndex.json
        $(selector).empty();
        var plugins = new PluginLoader(selector);
        plugins.load("pluginIndex.json", function(plugin, selector){
          Polymer.Base.importHref(plugin.location, function() {
            $(selector).append($('<li/>')
              .attr('id', 'plugin-' + plugin.name)
              .css('width', plugin.x * 290 + (plugin.x - 1) * 15)
              .attr('data-ss-colspan', plugin.x)
              .css('height',plugin.y * 290 + (plugin.y - 1) * 15)
              .addClass('card')
              .append(
                $('<'+ plugin.name +'/>')
              )
            );
          }, function() {
            console.log("error")
          });
        });
      });

      $( document ).on('pluginReady', function(e, event){
        reloadGrid(selector);
      });

      $('.search-input #input').keyup(function (e) {
        if (e.keyCode == 13) {
          var q = $('.search-input #input').val();
          eb.search(q);
          $(selector).empty();
          $('.search-input #input').blur();
        }
      });
      var query = window.location.hash.slice(2);
      if (query.match(/^\d+$/)){
        eb.searchID(query);
        $(selector).empty();
      }

      function reloadGrid(selector){
        var options = {
          minColumns: 2,
          gutterX: 15,
          gutterY: 15,
          handle: "header",
          centerWhileDragging: false,
          animationSpeed: 300
        };

        $(selector).shapeshift(options);
      }

      function $_GET(q,s) {
        s = s ? s : window.location.search;
        var re = new RegExp('&'+q+'(?:=([^&]*))?(?=&|$)','i');
        return (s=s.replace(/^\?/,'&').match(re)) ? (typeof s[1] == 'undefined' ? '' : decodeURIComponent(s[1])) : undefined;
      }
    }
  });
</script>
