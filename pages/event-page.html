<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
<script type="text/javascript" src="https://cdn.firebase.com/js/client/2.2.5/firebase.js"></script>
<script type="text/javascript" src="../js/shapeshift.js"></script>
<script type="text/javascript" src="../js/eventLoader.js"></script>
<script type="text/javascript" src="../js/pluginLoader.js"></script>

<dom-module id="event-page">
  <template>
    <paper-toolbar id="event-header" class="tall">
      <h3>HackBoard</h3>
      <div id="search-box">
        <div id="search">
          <paper-input class="search-input" label="search for an event" no-label-float></paper-input>
        </div>
        <paper-icon-button on-tap="searchEvent" icon="search" title="search"></paper-icon-button>
      </div>
    </paper-toolbar>

    <div id="info">
      <!-- page for when event isn't selected -->
      <!-- featuring user settings (name, profile picture etc) and saved events -->
    </div>

    <div id="search-results">
      <paper-material>
        <ul id="results">
        </ul>
      </paper-material>
    </div>

    <div id="deck">
      <ul id="plugins"></ul>
    </div>
  </template>
</dom-module>

<script>
  var selectedEvent;
  var eb;
  var pl;
  Polymer({
    is: "event-page",
    properties: {
      id: {
        type: String
      }
    },
    searchEvent: function() {
      // if the user presses enter in the searchbar, search their query
      var q = $('.search-input #input').val();
      if (q != "") {
        eb.search(q);
        $("#search-results").slideDown()
      }
    },
    attached: function(){
      var selector = '#plugins';
      // load all the plugins
      pl = new PluginLoader(selector);
      // prep the plugin data
      pl.load('pluginIndex.json');
      $( document ).on('pluginsReady', function(plugins, status){
        // All the plugins are ready to be loaded to the page.
      });

      eb = new EventLoader;
      // event search stuff
      // search for the event ID in the URL, if one exists
      var query = this.id
      if (query == "home") {
        console.log("home")
      } else if (query.match(/^\d+$/)){
        eb.searchID(query);
      } else {
        document.querySelector('app-router').go('/404')
      }

      var self = this;
      // if the user presses enter in the searchbar, search their query
      $('.search-input #input').keyup(function (e) {
        if (e.keyCode == 13) {
          self.searchEvent()
        }
      });

      $(document).on('eventIDRecognised', function(e, data) {
        eb.selectEvent(0)
      });

      $(document).on('eventSearchComplete', function(e, data) {
        $("#results").empty();
        var searchResults = data.events
        for (var i=0; i < searchResults.length; i++) {
          var eventId = searchResults[i].id
          if (searchResults[i].logo != undefined && searchResults[i].logo) {
            $("#results").append($("<li/>").append($("<search-result/>")
              .attr("name", searchResults[i].name.text)
              .attr("date", searchResults[i].start.local)
              .attr("logo", searchResults[i].logo.url)
              .click(function() {
                $("#search-results").slideUp()
                document.querySelector("app-router").go("/" + eventId)
              })
            ))
          } else {
            $("#results").append($("<li/>").append($("<search-result/>")
              .attr("name", searchResults[i].name.text)
              .attr("date", searchResults[i].start.local)
              .click(function() {
                $("#search-results").slideUp()
                document.querySelector("app-router").go("/" + eventId)
              })
            ))
          }
        }
      });

      $("search-result").click(function(sender) {
        $("#search-results").slideUp()
        document.querySelector("app-router").go("/" + sender.attr("id"))
      })

      $(document).on('eventSelected', function(e, data, status){
        // someone searched for something, and it's done loading.
        // put the event we're using into a ~global variable
        selectedEvent = eb.selectedEvent;
        // update the url
        window.history.pushState('', '', location.pathname + "#/" + selectedEvent.id);
        // time to add the plugins that we prep'd to the page.
        pl.prep();
        pl.placeRunPlugins();
      });

      $(document).on('pluginsOnPage', function() {
        // the plugins have been placed into the dom. Time to reload the
        // grid
        reloadGrid(selector);
        $('#deck ul').animate({
          opacity: 1
        }, 500)
      });

      function reloadGrid(selector){
        var options = {
          minColumns: 2,
          gutterX: 15,
          gutterY: 15,
          handle: "header",
          centerWhileDragging: false,
          animationSpeed: 300
        };

        $(selector).shapeshift(options);
      }
    }
  });
</script>
